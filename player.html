<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wayfinder Kiosk Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE V9 -->
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"
            }
        }
    </script>

    <style>
        body { overscroll-behavior: none; user-select: none; overflow: hidden; }
        @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 1; } 80%, 100% { transform: scale(1.5); opacity: 0; } }
        .you-are-here { position: relative; }
    </style>
</head>
<body class="bg-slate-900 h-screen w-screen overflow-hidden flex flex-col">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="absolute inset-0 z-50 bg-slate-900 flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-slate-700">
            <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6"><i class="fas fa-link text-white text-2xl"></i></div>
            <h1 class="text-2xl font-bold text-white mb-2">Connect Kiosk</h1>
            <p class="text-slate-400 mb-6">Enter the 6-character pairing code.</p>
            <input type="text" id="pairing-code-input" maxlength="6" class="w-full text-center text-3xl font-mono uppercase bg-slate-700 border border-slate-600 text-white rounded-lg py-4 mb-4" placeholder="ABC-123">
            <button onclick="window.pairDevice()" id="btn-pair" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg">Link Device</button>
            <p id="pair-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- KIOSK UI -->
    <div id="kiosk-ui" class="hidden flex-1 relative bg-slate-200">
        <canvas id="kioskCanvas" class="block w-full h-full"></canvas>

        <!-- SEARCH BAR (Top Right) -->
        <div class="absolute top-6 right-6 w-80 z-20">
            <div class="bg-white rounded-xl shadow-2xl flex items-center p-3 border border-slate-200">
                <i class="fas fa-search text-slate-400 ml-2"></i>
                <input type="text" id="search-input" class="flex-1 ml-3 outline-none text-sm text-slate-800" placeholder="Find store, room...">
                <button onclick="window.clearRoute()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="search-results" class="hidden mt-2 bg-white rounded-xl shadow-xl overflow-hidden max-h-64 overflow-y-auto border border-slate-100"></div>
        </div>

        <!-- QUICK ACTIONS (Bottom Right) -->
        <div class="absolute bottom-6 right-6 flex gap-3 z-20">
            <button onclick="window.findNearest('bathroom')" class="flex flex-col items-center gap-1 group">
                <div class="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-slate-600 group-active:scale-95 transition-transform"><i class="fas fa-restroom text-xl"></i></div>
                <span class="text-[10px] font-bold text-slate-600 bg-white/90 px-2 py-0.5 rounded-full">Restroom</span>
            </button>
            <button onclick="window.findNearest('elevator')" class="flex flex-col items-center gap-1 group">
                <div class="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-slate-600 group-active:scale-95 transition-transform"><i class="fas fa-elevator text-xl"></i></div>
                <span class="text-[10px] font-bold text-slate-600 bg-white/90 px-2 py-0.5 rounded-full">Elevator</span>
            </button>
            <button onclick="window.findNearest('stairs')" class="flex flex-col items-center gap-1 group">
                <div class="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-slate-600 group-active:scale-95 transition-transform"><i class="fas fa-walking text-xl"></i></div>
                <span class="text-[10px] font-bold text-slate-600 bg-white/90 px-2 py-0.5 rounded-full">Stairs</span>
            </button>
            <button onclick="window.findNearest('kiosk')" class="flex flex-col items-center gap-1 group">
                <div class="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-slate-600 group-active:scale-95 transition-transform"><i class="fas fa-info text-xl"></i></div>
                <span class="text-[10px] font-bold text-slate-600 bg-white/90 px-2 py-0.5 rounded-full">Info</span>
            </button>
        </div>

        <!-- DIRECTIONS CARD (Bottom Left - for instructions) -->
        <div id="directions-card" class="absolute bottom-6 left-6 bg-white rounded-xl shadow-2xl p-4 transform translate-y-[150%] transition-transform duration-300 w-64">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white text-lg mr-3"><i class="fas fa-walking"></i></div>
                <div>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Navigating to</p>
                    <h3 class="text-sm font-bold text-slate-900 truncate w-32" id="target-name">Target</h3>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, serverTimestamp } from "firebase/firestore";

        const firebaseConfig = {
            apiKey: "AIzaSyDWJ5qVnsA3rWvfkc0-_cIyfwLHEZNMuxE",
            authDomain: "wayfinder-app-a2565.firebaseapp.com",
            projectId: "wayfinder-app-a2565",
            storageBucket: "wayfinder-app-a2565.firebasestorage.app",
            messagingSenderId: "770872636942",
            appId: "1:770872636942:web:f342a0d96de313a19a6e5f"
        };

        let db;
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e) { console.error(e); }

        let mapData = null, img = new Image(), scale = 1, offset = {x:0, y:0}, activePath = [], unsubscribeListener = null;
        const canvas = document.getElementById('kioskCanvas'), ctx = canvas.getContext('2d');

        // --- PAIRING ---
        const savedCode = localStorage.getItem('wayfinder_pairing_code');
        if (savedCode) listenToConnection(savedCode); else showSetupScreen();

        window.pairDevice = async function() {
            const codeInput = document.getElementById('pairing-code-input').value.toUpperCase().trim();
            if (codeInput.length < 6) return;
            document.getElementById('btn-pair').innerText = "Verifying...";
            try {
                const codeRef = doc(db, "pairing_codes", codeInput);
                const docSnap = await getDoc(codeRef);
                if (!docSnap.exists()) throw new Error("Invalid Code");
                await updateDoc(codeRef, { status: 'active', pairedDevice: 'dev_'+Date.now(), pairedAt: serverTimestamp() });
                localStorage.setItem('wayfinder_pairing_code', codeInput);
                listenToConnection(codeInput);
            } catch (err) {
                document.getElementById('pair-error').innerText = err.message;
                document.getElementById('pair-error').classList.remove('hidden');
                document.getElementById('btn-pair').innerText = "Link Device";
            }
        };

        function listenToConnection(code) {
            if (unsubscribeListener) unsubscribeListener();
            const btn = document.getElementById('btn-pair'); if(btn) btn.innerText = "Syncing...";
            unsubscribeListener = onSnapshot(doc(db, "pairing_codes", code), async (snapshot) => {
                if (!snapshot.exists()) { localStorage.removeItem('wayfinder_pairing_code'); window.location.reload(); return; }
                const data = snapshot.data();
                if (data.mapId) loadMap(data.mapId, code);
            });
        }

        function showSetupScreen() {
            document.getElementById('setup-screen').classList.remove('hidden');
            document.getElementById('kiosk-ui').classList.add('hidden');
        }

        async function loadMap(mapId, pairingCode) {
            try {
                const codeDoc = await getDoc(doc(db, "pairing_codes", pairingCode));
                if (!codeDoc.exists()) return;
                const pData = codeDoc.data();
                const mapRef = pData.ownerId ? doc(db, "users", pData.ownerId, "maps", mapId) : doc(db, "maps", mapId);
                
                onSnapshot(mapRef, (docSnap) => {
                    if (docSnap.exists()) {
                        mapData = docSnap.data();
                        const newImg = new Image();
                        newImg.onload = () => {
                            img = newImg; fitToScreen(); draw();
                            document.getElementById('setup-screen').classList.add('hidden');
                            document.getElementById('kiosk-ui').classList.remove('hidden');
                        };
                        newImg.src = mapData.metadata.mapImage;
                    }
                });
            } catch (e) { console.error(e); }
        }

        // --- RENDERER ---
        function fitToScreen() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(!img.width) return;
            scale = Math.min(canvas.width / img.width, canvas.height / img.height);
            offset.x = (canvas.width - img.width * scale) / 2; offset.y = (canvas.height - img.height * scale) / 2;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.save();
            ctx.translate(offset.x, offset.y); ctx.scale(scale, scale);
            if(img.src && img.complete) ctx.drawImage(img, 0, 0);
            if (activePath.length > 0) {
                ctx.beginPath(); ctx.lineWidth = 6 / scale; ctx.strokeStyle = '#2563eb'; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.moveTo(activePath[0].x, activePath[0].y);
                for(let i=1; i<activePath.length; i++) ctx.lineTo(activePath[i].x, activePath[i].y);
                ctx.stroke();
                // Markers
                ctx.beginPath(); ctx.arc(activePath[0].x, activePath[0].y, 10/scale, 0, Math.PI*2); ctx.fillStyle = '#ef4444'; ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth = 3/scale; ctx.stroke();
                ctx.beginPath(); ctx.arc(activePath[activePath.length-1].x, activePath[activePath.length-1].y, 10/scale, 0, Math.PI*2); ctx.fillStyle = '#10b981'; ctx.fill(); ctx.stroke();
            }
            ctx.restore();
        }

        // --- NAVIGATION ---
        function findPath(startId, endId) {
            if(!mapData?.nodes) return [];
            // Simplified Pathfinding
            const start = mapData.nodes.find(n=>n.id===startId), end = mapData.nodes.find(n=>n.id===endId);
            return (start && end) ? [start, end] : []; // Replace with A* in prod
        }

        window.findNearest = function(type) {
            if(!mapData) return;
            const kiosk = mapData.nodes.find(n => n.type === 'kiosk');
            if(!kiosk) { alert("Kiosk location not set on map"); return; }
            const targets = mapData.nodes.filter(n => n.type === type);
            if(targets.length === 0) { alert("No " + type + " found."); return; }
            
            // Find nearest
            let nearest = null, minDist = Infinity;
            targets.forEach(t => {
                const d = Math.hypot(t.x - kiosk.x, t.y - kiosk.y);
                if(d < minDist) { minDist = d; nearest = t; }
            });
            window.startNavigation(nearest);
        };

        window.startNavigation = function(targetNode) {
            const searchRes = document.getElementById('search-results');
            searchRes.classList.add('hidden');
            document.getElementById('search-input').value = targetNode.name;
            
            const kiosk = mapData.nodes.find(n => n.type === 'kiosk');
            if(!kiosk) return;

            activePath = findPath(kiosk.id, targetNode.id);
            document.getElementById('directions-card').classList.remove('translate-y-[150%]');
            document.getElementById('target-name').innerText = targetNode.name;
            draw();
        };

        window.clearRoute = function() {
            activePath = [];
            document.getElementById('search-input').value = '';
            document.getElementById('directions-card').classList.add('translate-y-[150%]');
            draw();
        };

        // Search Listener
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const box = document.getElementById('search-results');
            if(term.length < 1) { box.classList.add('hidden'); return; }
            
            const matches = mapData.nodes.filter(n => n.type === 'destination' && n.name.toLowerCase().includes(term));
            box.innerHTML = '';
            matches.forEach(n => {
                const el = document.createElement('div');
                el.className = "p-3 border-b hover:bg-slate-50 cursor-pointer flex justify-between";
                el.innerHTML = `<span class="font-bold text-slate-700">${n.name}</span><span class="text-xs text-slate-400 capitalize">${n.type}</span>`;
                el.onclick = () => window.startNavigation(n);
                box.appendChild(el);
            });
            box.classList.remove('hidden');
        });

        window.addEventListener('resize', () => { if(img.src) { fitToScreen(); draw(); } });
    </script>
</body>
</html>
