<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wayfinder Kiosk Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"
            }
        }
    </script>

    <style>
        body { overscroll-behavior: none; user-select: none; overflow: hidden; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    </style>
</head>
<body class="bg-slate-900 h-screen w-screen overflow-hidden flex flex-col">

    <div id="a11y-announcer" class="sr-only" aria-live="polite"></div>

    <div id="setup-screen" class="absolute inset-0 z-50 bg-slate-900 flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-slate-700">
            <h1 class="text-2xl font-bold text-white mb-2">Connect Kiosk</h1>
            <label for="pairing-code-input" class="text-slate-400 mb-6 block">Enter the 6-character pairing code.</label>
            <input type="text" id="pairing-code-input" maxlength="6" class="w-full text-center text-3xl font-mono uppercase bg-slate-700 border border-slate-600 text-white rounded-lg py-4 mb-4" placeholder="ABC-123">
            <button onclick="window.pairDevice()" id="btn-pair" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg">Link Device</button>
            <p id="pair-error" class="text-red-500 text-sm mt-4 hidden" role="alert"></p>
        </div>
    </div>

    <div id="kiosk-ui" class="hidden flex-1 relative bg-slate-200" aria-hidden="true">
        <canvas id="kioskCanvas" class="block w-full h-full" aria-label="Interactive Map" role="img"></canvas>

        <div class="absolute top-6 right-6 w-80 z-20">
            <div class="bg-white rounded-xl shadow-2xl flex items-center p-3 border border-slate-200">
                <i class="fas fa-search text-slate-400 ml-2" aria-hidden="true"></i>
                <label for="search-input" class="sr-only">Search for a location</label>
                <input type="text" id="search-input" class="flex-1 ml-3 outline-none text-sm text-slate-800" placeholder="Find store, room...">
                <button onclick="window.clearRoute()" class="text-slate-400 hover:text-slate-600" aria-label="Clear Search"><i class="fas fa-times"></i></button>
            </div>
            <div id="search-results" class="hidden mt-2 bg-white rounded-xl shadow-xl overflow-hidden max-h-96 overflow-y-auto border border-slate-100" role="listbox"></div>
        </div>

        <div class="absolute bottom-6 right-6 flex gap-3 z-20">
            <button onclick="window.findNearest('bathroom')" class="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-slate-600 active:scale-95 transition-transform"><i class="fas fa-restroom text-xl"></i></button>
            <button onclick="window.findNearest('elevator')" class="w-14 h-14 bg-white rounded-full shadow-xl flex items-center justify-center text-slate-600 active:scale-95 transition-transform"><i class="fas fa-elevator text-xl"></i></button>
        </div>

        <div id="directions-card" class="absolute bottom-6 left-6 bg-white rounded-xl shadow-2xl p-5 transform translate-y-[150%] transition-transform duration-300 w-80 border border-slate-100" aria-live="assertive">
            <div class="flex items-start">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center text-white text-xl mr-4 shrink-0 shadow-lg shadow-blue-200">
                    <img id="target-logo" class="hidden w-full h-full object-cover rounded-lg" />
                    <i id="target-icon" class="fas fa-walking"></i>
                </div>
                <div class="flex-1">
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-0.5">Navigating to</p>
                    <h3 class="text-lg font-bold text-slate-900 leading-tight mb-1" id="target-name">Target</h3>
                    
                    <div id="target-meta" class="text-sm text-slate-500 space-y-1">
                        <p id="target-desc" class="line-clamp-2 hidden"></p>
                        <p id="target-hours" class="text-xs font-semibold text-green-600 bg-green-50 inline-block px-2 py-0.5 rounded hidden"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, serverTimestamp } from "firebase/firestore";

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDWJ5qVnsA3rWvfkc0-_cIyfwLHEZNMuxE",
            authDomain: "wayfinder-app-a2565.firebaseapp.com",
            projectId: "wayfinder-app-a2565",
            storageBucket: "wayfinder-app-a2565.firebasestorage.app",
            messagingSenderId: "770872636942",
            appId: "1:770872636942:web:f342a0d96de313a19a6e5f"
        };

        let db;
        try { const app = initializeApp(FIREBASE_CONFIG); db = getFirestore(app); } catch(e) { console.error("Firebase Error", e); }

        const state = { mapData: null, img: new Image(), scale: 1, offset: {x:0, y:0}, activePath: [], isDirty: false };
        const canvas = document.getElementById('kioskCanvas'), ctx = canvas.getContext('2d');

        // --- PAIRING ---
        const savedCode = localStorage.getItem('wayfinder_pairing_code');
        if (savedCode) listenToConnection(savedCode); else showSetupScreen();

        window.pairDevice = async function() {
            const rawInput = document.getElementById('pairing-code-input').value;
            const codeInput = rawInput.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            if (codeInput.length < 6) return;
            document.getElementById('btn-pair').innerText = "Verifying...";
            try {
                const codeRef = doc(db, "pairing_codes", codeInput);
                const docSnap = await getDoc(codeRef);
                if (!docSnap.exists()) throw new Error("Invalid Code");
                await updateDoc(codeRef, { status: 'active', pairedDevice: 'dev_'+Date.now(), pairedAt: serverTimestamp() });
                localStorage.setItem('wayfinder_pairing_code', codeInput);
                listenToConnection(codeInput);
            } catch (err) {
                document.getElementById('pair-error').innerText = err.message;
                document.getElementById('pair-error').classList.remove('hidden');
                document.getElementById('btn-pair').innerText = "Link Device";
            }
        };

        function listenToConnection(code) {
            onSnapshot(doc(db, "pairing_codes", code), (snapshot) => {
                if (!snapshot.exists()) { localStorage.removeItem('wayfinder_pairing_code'); window.location.reload(); return; }
                const data = snapshot.data();
                if (data.mapId) loadMap(data.mapId, code);
            });
        }

        function showSetupScreen() {
            document.getElementById('setup-screen').classList.remove('hidden');
            document.getElementById('kiosk-ui').classList.add('hidden');
        }

        async function loadMap(mapId, pairingCode) {
            try {
                const codeDoc = await getDoc(doc(db, "pairing_codes", pairingCode));
                if (!codeDoc.exists()) return;
                const pData = codeDoc.data();
                const mapRef = pData.ownerId ? doc(db, "users", pData.ownerId, "maps", mapId) : doc(db, "maps", mapId);
                
                onSnapshot(mapRef, (docSnap) => {
                    if (docSnap.exists()) {
                        state.mapData = docSnap.data();
                        const newImg = new Image();
                        newImg.onload = () => {
                            state.img = newImg; fitToScreen(); state.isDirty = true;
                            document.getElementById('setup-screen').classList.add('hidden');
                            document.getElementById('kiosk-ui').classList.remove('hidden');
                        };
                        newImg.src = state.mapData.metadata.mapImage;
                    }
                });
            } catch (e) { console.error(e); }
        }

        // --- RENDERER ---
        function fitToScreen() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            if(!state.img.width) return;
            state.scale = Math.min(canvas.width / state.img.width, canvas.height / state.img.height);
            state.offset.x = (canvas.width - state.img.width * state.scale) / 2;
            state.offset.y = (canvas.height - state.img.height * state.scale) / 2;
        }

        function draw() {
            if (!state.isDirty) { requestAnimationFrame(draw); return; }
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.save();
            ctx.translate(state.offset.x, state.offset.y); ctx.scale(state.scale, state.scale);
            if(state.img.src && state.img.complete) ctx.drawImage(state.img, 0, 0);
            
            if (state.activePath.length > 0) {
                ctx.beginPath(); ctx.lineWidth = 6 / state.scale; ctx.strokeStyle = '#2563eb'; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.moveTo(state.activePath[0].x, state.activePath[0].y);
                for(let i=1; i<state.activePath.length; i++) ctx.lineTo(state.activePath[i].x, state.activePath[i].y);
                ctx.stroke();
                
                // Draw Markers respecting Custom Color if present
                drawMarker(state.activePath[0], '#ef4444');
                const endNode = state.activePath[state.activePath.length-1];
                drawMarker(endNode, endNode.color || '#10b981');
            }
            ctx.restore();
            state.isDirty = false;
            requestAnimationFrame(draw);
        }

        function drawMarker(node, defaultColor) {
            ctx.beginPath(); ctx.arc(node.x, node.y, 10/state.scale, 0, Math.PI*2);
            ctx.fillStyle = defaultColor; ctx.fill(); 
            ctx.strokeStyle = 'white'; ctx.lineWidth = 3/state.scale; ctx.stroke();
        }
        requestAnimationFrame(draw);

        // --- NAVIGATION & FEATURES ---
        window.findNearest = function(type) {
            if(!state.mapData) return;
            const kiosk = state.mapData.nodes.find(n => n.type === 'kiosk');
            if(!kiosk) return alert("Kiosk not set");
            const targets = state.mapData.nodes.filter(n => n.type === type);
            if(targets.length === 0) return alert("None found");
            
            let nearest = null, minDist = Infinity;
            targets.forEach(t => {
                const d = Math.hypot(t.x - kiosk.x, t.y - kiosk.y);
                if(d < minDist) { minDist = d; nearest = t; }
            });
            window.startNavigation(nearest);
        };

        window.startNavigation = function(targetNode) {
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('search-input').value = targetNode.name;
            
            const kiosk = state.mapData.nodes.find(n => n.type === 'kiosk');
            if(!kiosk) return;

            state.activePath = [kiosk, targetNode]; // Replace with A* in prod
            
            // --- POPULATE INFO CARD ---
            const card = document.getElementById('directions-card');
            const logoImg = document.getElementById('target-logo');
            const icon = document.getElementById('target-icon');
            const desc = document.getElementById('target-desc');
            const hours = document.getElementById('target-hours');

            document.getElementById('target-name').textContent = targetNode.name;

            // 1. Logo Handling
            if (targetNode.logo) {
                logoImg.src = targetNode.logo;
                logoImg.classList.remove('hidden');
                icon.classList.add('hidden');
            } else {
                logoImg.classList.add('hidden');
                icon.classList.remove('hidden');
            }

            // 2. Description Handling
            if (targetNode.description) {
                desc.textContent = targetNode.description;
                desc.classList.remove('hidden');
            } else {
                desc.classList.add('hidden');
            }

            // 3. Hours Handling
            if (targetNode.openTime && targetNode.closeTime) {
                hours.textContent = `Open: ${targetNode.openTime} - ${targetNode.closeTime}`;
                hours.classList.remove('hidden');
            } else {
                hours.classList.add('hidden');
            }

            card.classList.remove('translate-y-[150%]');
            state.isDirty = true;
        };

        window.clearRoute = function() {
            state.activePath = [];
            document.getElementById('search-input').value = '';
            document.getElementById('directions-card').classList.add('translate-y-[150%]');
            state.isDirty = true;
        };

        // --- SEARCH with LOGOS ---
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const box = document.getElementById('search-results');
            if(term.length < 1) { box.classList.add('hidden'); return; }
            
            // Allow searching by Name OR Custom Type
            const matches = state.mapData.nodes.filter(n => {
                if (n.type === 'walkable' || n.type === 'kiosk') return false;
                const matchName = n.name.toLowerCase().includes(term);
                const matchType = n.customTypeLabel ? n.customTypeLabel.toLowerCase().includes(term) : false;
                return matchName || matchType;
            });

            box.innerHTML = '';
            matches.forEach(n => {
                const el = document.createElement('div');
                el.className = "p-3 border-b hover:bg-slate-50 cursor-pointer flex items-center gap-3";
                
                // Show Logo in Search List
                let iconHTML = `<div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400"><i class="fas fa-map-marker-alt"></i></div>`;
                if (n.logo) {
                    iconHTML = `<img src="${n.logo}" class="w-10 h-10 rounded-full object-cover border border-slate-200" />`;
                }

                el.innerHTML = `
                    ${iconHTML}
                    <div>
                        <div class="font-bold text-slate-700 text-sm">${n.name}</div>
                        <div class="text-xs text-slate-400 capitalize">${n.customTypeLabel || n.type}</div>
                    </div>
                `;
                el.onclick = () => window.startNavigation(n);
                box.appendChild(el);
            });
            box.classList.remove('hidden');
        });

        window.addEventListener('resize', () => { if(state.img.src) { fitToScreen(); state.isDirty = true; } });
    </script>
</body>
</html>
